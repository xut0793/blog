# 微前端 micro-frontends

参考链接：
- [Micro Frontends](https://swearer23.github.io/micro-frontends/)
- [微前端-最容易看懂的微前端知识](https://juejin.cn/post/6844904162509979662#heading-8)
- [微前端如何落地？](https://segmentfault.com/a/1190000019663742?utm_source=sf-similar-article)

## What 什么是微前端

微前端 这个名词，第一次被提出是2016年底，在 ThoughtWorks Technology 大会上 Radar 提出。这个概念是将广泛应用于服务端的微服务理念扩展到前端领域。微前端不是单纯的前端框架或者工具，而是一种架构设计。

微前端（Micro-Frontends）是一种类似于微服务的架构，它将微服务的理念应用到浏览器端，核心思想是将 Web 应用由单一的单体应用转变为由多个小型前端应用聚合为一的应用。各个前端应用可以独立开发、独立运行、独立部署。

## Why 为什么用微前端，它解决了什么问题

任何新技术或者新架构方式的产生都是为了解决现有场景和需求下的技术痛点，微前端也不例外：

当下前端领域，单页面应用（SPA）是非常流行的项目形态之一。而随着时间的推移以及应用功能的丰富，单页应用变得不再单一而是越来越庞大也越来越难以维护，我们给这种应用起名为巨石单体应用。对它们往往是改一处而动全身，由此带来的发版成本也越来越高。微前端的意义就是将这些庞大应用进行拆分，并随之解耦，每个部分可以单独进行维护和部署，提升效率。

微前端架构的设计理念，或者说核心思想：
- **技术栈无关**：每个团队应该选择自己的技术栈以及技术进化路线，而不是与其他团队步调一致。在微前端的语境之下，框架将不是未来架构师主要考虑的问题，如何高效的提供可复用的微应用会成为核心问题。
- **应用自治**：即便所有团队都使用同样的框架，也不要共享同一个运行时环境。构建自包含的应用，不要依赖共享的状态或者全局变量。只需要遵循统一的框架接口规范，以便应用能集成到一起即可。但在还不能做到完全隔离的环境下，可以通过命名约定进行隔离。对于CSS，事件，Local Storage 以及 Cookies之类的环境中，通过命名空间进行的隔离可以避免冲突，以及所有权。

总结微前端的理解：
- 看到有一句这样评论微前端，十分有意思： 微前端就是分而治之的手段，让「上帝的归上帝，凯撒的归凯撒」。
- 微前端借鉴微服务，但两者的关注点有区别：微服务注重解耦，微前端讲究聚合。
- 微前端的思想是由大而全，转变为小而美。
- 微前端的核心在于先拆后合。

## How 如何实现微前端，实现微前端的几种技术方案

### 微前端的两种形态

- **单实例**：同时运行的只有一个应用，我们会从应用 A 切换到应用 B，从应用 B 切换到应用 C，但我们不会同时把应用 A 和应用 B 都挂载在页面上，这是一种单实例的场景。
- **多实例**：在一个页面里可以挂载多个微应用，你可以同时把应用 A、应用 B、应用 C 和应用 D 合计 4 个应用全部在同一个页面里。在这种情况下子应用往往是没有自己的路由的，与路由无关。

### 微前端的两种解决方案

从微前端应用间的关系来看，实现微前端的解决方案分为两种：基座模式（管理式）、去中心化模式（自组织式）。

- **基座模式**。通过一个主应用，来管理其它应用。设计难度小，方便实践，但是通用度低。
- **去中心化模式**。应用之间是平等的，不存在相互管理的模式。设计难度大，不方便实施，但是通用度高，qiankun发展方向也在由一开发的基座模式逐渐向去中心化模式转变成一个通用的微应用加载器。

### 微前端实现的共同问题

在微前端实现过程中，有些共同的问题需要实现，包括：
- **应用的注册**：这个应用注册表表明每个应用信息，包括应用的标识和入口。在前端实现里，入口的直接表现形式可以是路由。
- **应用的发现**：即让主应用可以寻找到子应用。在前端实现里，直接表现为路由劫持和路由匹配。
- **应用的生命周期**：由主框架统一规范，去同步各个框架。以代表框架Single-SPA为例，bootstrap，获取静态资源；Mount，安装应用，比如创建 DOM 节点；Unmount，卸载应用，如删除 DOM 节点、取消事件绑定等。不同技术栈的子应用匹配主应用对应的生命周期。
- **应用的隔离**：直白话讲，就是让应用跑在一个隔离的环境下，不对外界的其他程序造成影响。包括，CSS隔离，保证应用样式不会相互污染，其实现的技术方案包括CSS Module、Dynamic Stylesheet、Shadow DOM等。JavaScript隔离最普遍的做法是采用沙箱机制（SandBox），其实现主流技术方案包括快照snapshoot模式和代理proxy模式。
- **应用的通信**：要让多个分离的微应用之间通信，本质上仍离不开中间媒介或者说全局对象。所以浏览器原生的自定义事件(customEvent)机制，或者全局的消息订阅(pub/sub)模式的通信机制是非常适用的。
- **应用的状态**：全局状态管理器

> 原生浏览器标准优先于框架封装的API，比如使用原生浏览器自定义事件机制(customEvent)来构建应用间的通信 ，而不是自己构建一个PubSub系统。如果确实需要设计一个应用间的通信API，那么也尽量让设计简单为好。

目前落地并开源的技术方案：
- 基座模式：
  - [Single-Spa](https://zh-hans.single-spa.js.org/)
  - 基于 Single-Spa 的 [Qiankun](https://qiankun.umijs.org/zh) （蚂蚁金服）
  - [Garfish](https://garfish.top/)（字节跳动）
  - [icestark](https://icestark.gitee.io/)（阿里巴巴）
- 去中心化的基于webpack5 module federation 实现的[EMP](https://github.com/efoxTeam/emp/blob/main/README-zh_CN.md)(YY 欢聚时代)
- 基于 Web Components 实现[micro-app](https://micro-zoe.github.io/micro-app/)（京东）

> [微前端框架 - qiankun 作者解读 qiankun 的诞生](https://juejin.cn/post/6846687602439897101#heading-24)

### 为什么不是 iframe

如果不考虑体验，iframe是最好的微前端方案。当其他方案不靠谱或者不兼容的时候，使用iframe是成本最低，且风险最小的方案。
1. frame 最大的优势是提供了浏览器原生的硬隔离方案，不论是样式隔离、js 隔离这类问题统统都能被完美解决。

但他的最大问题也在于他的隔离性无法被突破，导致应用间上下文无法被共享，随之带来的开发体验、产品体验的问题。所以 iframe 的弊端也是十分明显的。

1. 浏览器刷新时，iframe url 状态丢失、后退前进按钮无法使用。
2. UI 不同步，DOM 结构不共享。想象一下屏幕右下角 1/4 的 iframe 里来一个带遮罩层的弹框，同时我们要求这个弹框要浏览器居中显示，还要浏览器 resize 时自动居中..
3. 没有状态管理器的概念。内存变量不共享。需要实现数据的传输，只能通过cookies等，还需要刷新所有的iframe才有最终效果。
4. 慢，所有的资源，都需要重新加载。会新增很多请求。
5. iframe嵌入的信息，无法完成SEO的抓取。
6. 多个iframe，每个iframe超出时，都会出现各自的滚动条，让人一脸懵逼。
7. 等待交互时，无法添加动效，只能白屏等待。
8. iframe 会造成页面阻塞加载，无法异步处理。
9. 网页截屏等一些交互动作，iframe 无法实现。

## Deep 深入微前端，剖析实现微前端的几种框架源码
- []自己实现一个微前端框架
- []qiankun框架使用和源码解析
- []micro-app 框架的使用和源码解析
- []EMP 框架的使用和源码解析

## 参考链接
- [拥抱云时代的前端开发架构——微前端](https://mp.weixin.qq.com/s?__biz=Mzg4MjE5OTI4Mw==&mid=2247483871&idx=1&sn=49184495651a53d461dad65164cf6367&scene=21#wechat_redirect) --- 展示了一个微前端体系图
- [阿里云开放平台微前端方案的沙箱实现](https://mp.weixin.qq.com/s/yXi1jYACrDAFqT7IKv3a5w)
- [在字节跳动设计与实践微前端沙盒](https://juejin.cn/post/6844904205367377928)
- [微前端主子应用路由调度](https://juejin.cn/post/6847902217945481224)
- [Vue+微前端(QianKun)落地实施和最后部署上线总结（二）普通版](https://juejin.cn/post/7041151571467436063)
- [从零开始写一个微前端框架-渲染篇](https://juejin.cn/post/6992041506919940109)
- [从零开始写一个微前端框架-沙箱篇](https://juejin.cn/post/6992489447891664903)
- [从零开始写一个微前端框架-样式隔离篇](https://juejin.cn/post/6992876656125804551)
- [从零开始写一个微前端框架-数据通信篇](https://juejin.cn/post/6993210363072217096)
