# 前端监控

前端监控的目的：获取用户行为以及跟踪产品在用户端的使用情况，并以监控数据为基础，分析总结产品优化的方向。

所以前端监控和前端埋点，一个是目的，一个是实现方式，前端埋点，是为做前端监控收集数据。

根据监控的数据类型分类：运营数据监控、性能指标监控和异常错误监控。

## 监控数据的分类
### 运营数据监控

运营数据监控，主要是监控用户的行为，常见的监控数据项有：

- PV/UV
  - PV (page view) 访问量：页面被刷新一次就计算一次。如果网站被刷新了1000次，那么流量统计工具显示的pv就是1000。
  - UV (Unique Visitor) 独立访客：以客户端 IP 识别为一个访客。0:00-24:00内相同的客户端 IP 只被计算一次。
- 用户在应用或者每一个页面的停留时间
- 用户通过什么入口来访问该网页
- 用户在相应的页面中触发的行为

统计这些数据是有意义的，比如我们知道了用户来源的渠道，可以促进产品的推广，知道用户在每一个页面停留的时间，可以针对停留较长的页面，增加广告推送等等。

### 性能指标监控

性能指标监控，主要包括监听网页或者说产品在用户端的体验。常见的性能监控项包括：

- 不同用户，不同机型和不同系统下的首屏加载时间
- 首屏白屏时间
- http 等请求的响应时间
- 静态资源整体下载时间
- 页面渲染时间
- 页面交互动画完成时间

这些性能监控的结果，可以展示前端性能的好坏，根据性能监测的结果可以进一步的去优化前端性能，比如兼容低版本浏览器的动画效果，加快首屏加载等等。

主要两个方向：1. 如何收集性能指标数据；2. 如何优化前端应用性能

### 异步错误监控

由于产品的前端代码在执行过程中也会发生异常，因此需要引入异常监控。及时的上报异常情况，可以避免线上故障的发上。虽然大部分异常可以通过 try catch 的方式捕获，但是比如内存泄漏以及其他偶现的异常难以捕获。常见的需要监控的异常包括：

- Javascript 的异常监控
- 样式丢失的异常监控

实现前端监控的流程：
1. 肯定是将我们要监控的数据收集起来，提交给后台
2. 后台对数据进行分析，对应用异常进行警报，或者为产品后续功能优化指引方向。

所以数据收集的丰富性和准确性会直接影响到前端监控的质量，收集监控数据就需要通过前端埋点来实现，目前常见的前端埋点方法有三种：手动埋点、可视化埋点和无埋点。

## 前端埋点的分类

### 手动埋点

手动埋点，也叫代码埋点，即纯手动写代码，调用埋点 SDK 的函数，在需要埋点的业务逻辑功能位置调用接口，上报埋点数据，像友盟、百度统计等第三方数据统计服务商大都采用这种方案。

优势：精细化自定义分析时，需要准确的数据，手动埋点可以方便地设置自定义属性、自定义事件。
劣势：、
- 项目工程量大，需要埋点的位置太多，成本高。
- 手动埋点需要内嵌埋点代码，与业务代码耦合，所以每次有埋点更新，或者漏埋点，都需要重新走上线发布流程，更新成本也高，对线上系统稳定性也有一定危害。

### 可视化埋点

可视化埋点通过可视化交互的手段，代替上述的代码埋点。将业务代码和埋点代码分离，提供一个可视化交互的页面，可以在业务代码中自定义的增加埋点事件等等，最后输出的代码耦合了业务代码和埋点代码。

可视化埋点听起来比较高大上，实际上跟代码埋点还是区别不大。也就是用一个系统来实现手动插入代码埋点的过程。比如国外比较早做可视化的是 Mixpanel，国内较早支持可视化埋点的有TalkingData、诸葛 IO，2017年腾讯的 MTA 也宣布支持可视化埋点。

可视化埋点的实现多数基于Xpath的方案，XPath 是一门在 XML 文档中查找信息的语言，XPath 可用来在 XML 文档中对元素和属性进行遍历。

优点：支持产品运营随时调整埋点，无需再走发版流程，直接把配置结果推入到前端，数据采集流程更简化，也更方便产品的迭代。
缺点：就是可以埋点的控件有限，不能手动定制。

### 全埋点（无埋点）

无埋点则是前端自动采集全部事件，上报埋点数据，由后端来过滤和计算出有用的数据。采用无埋点技术的有主流的 GrowingIO、神策。

优点：是前端只要一次加载埋点脚本
缺点：是流量和采集的数据过于庞大，服务器性能压力山大。

在不同场景下我们需要选择不同的埋点方案。例如对于简单的用户行为类事件，可以使用全埋点解决；而对于需要携带大量运行时才可获知的业务字段的埋点需求，就需要手动代码埋点来解决。

## 埋点实践

- 如何收集运营数据，并上报 [如何实现用户行为的动态采集与分析](https://www.zoo.team/article/user-data-analysis)
- 如何收集性能指标数据，并上报 [window.performance]() --- 转前端性能分析
- 如何收集应用异步数据，并上报 [前端异常埋点系统初探](https://juejin.cn/post/6965022635470110733)

## 参考链接
- [前端-埋点-理念-通识-浅谈](https://juejin.cn/post/6844903877406359560#heading-15)
- [前端监控和前端埋点](https://zhuanlan.zhihu.com/p/65834362)
- [前端埋点的那些事](https://www.imooc.com/article/27151)